---
import { getCollection, getEntry, render } from 'astro:content'
import Layout from '../layouts/Layout.astro'

export async function getStaticPaths() {
  const projects = await getCollection('projects')
  return projects.map((project) => ({
    params: { project: project.data.slug },
    props: { project: project.data },
  }))
}

const { project } = Astro.props
const entry = await getEntry('projects', project.slug)
if (!entry) {
  throw new Error('Could not find project')
}
const { Content } = await render(entry)

const projectSchema = {
  '@context': 'https://schema.org',
  '@type': 'SoftwareSourceCode',
  name: project.title,
  description: project.description,
  datePublished: project.date,
  author: {
    '@type': 'Person',
    name: 'Rafael Caixeta',
    url: 'https://caixeta.dev',
  },
  codeRepository: project.githubLink,
  url: project.previewLink,
  programmingLanguage: project.technologies.map((t) => t.language),
  image: `https://caixeta.dev${project.image}`,
}
---

<Layout
  title={project.title}
  description={project.description}
  image={!!project.image ? project.image : '/og.jpg'}
>
  <Fragment slot="head">
    <script is:inline type="application/ld+json" set:html={JSON.stringify(projectSchema)} />
  </Fragment>

  <div>
    <a href="/" class="text-muted-foreground text-sm hover:text-foreground"
      >&larr; Home</a
    >

    <div class="flex flex-col gap-1 w-full mt-4">
      <h1 class="capitalize text-2xl">{project.title}</h1>
      <p class="text-muted-foreground text-xs">{project.date}</p>
    </div>

    <div class="text-muted-foreground my-2 flex flex-col gap-4">
      <Content />
    </div>

    {
      !!project.image && (
        <a class="opacity-100!" target="_blank" href={project.previewLink}>
          <img
            src={project.image}
            alt={`Screenshot of ${project.title} project by Rafael Caixeta`}
            fetchpriority="high"
          />
        </a>
      )
    }

    {
      !!project.githubLink && (
        <div class="mt-2 text-xs text-muted-foreground">
          <a href={project.githubLink} target="_blank" rel="noopener noreferrer">
            View Code
          </a>
        </div>
      )
    }

    <div class="mt-6">
      <h2>Technologies Used:</h2>
      <div class="flex flex-wrap gap-2 mt-2 text-muted-foreground">
        {
          project.technologies.map((technologie) => (
            <a href={technologie.link} target="_blank" rel="noopener noreferrer">
              {technologie.language}
            </a>
          ))
        }
      </div>
    </div>
  </div>
</Layout>
